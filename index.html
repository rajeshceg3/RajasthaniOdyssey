<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net/npm/gsap@3.12.2/ 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com; img-src 'self' https://images.unsplash.com data:; media-src https://assets.codepen.io; connect-src https://fonts.googleapis.com https://fonts.gstatic.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maru</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="locations.css">

    <!-- Preload ambient sounds -->
    <link rel="preload" href="https://assets.codepen.io/134442/jaipur.mp3" as="audio">
    <link rel="preload" href="https://assets.codepen.io/134442/jodhpur.mp3" as="audio">
    <link rel="preload" href="https://assets.codepen.io/134442/jaisalmer.mp3" as="audio">
    <link rel="preload" href="https://assets.codepen.io/134442/udaipur.mp3" as="audio">
    <link rel="preload" href="https://assets.codepen.io/134442/thar.mp3" as="audio">
    <link rel="preload" href="https://assets.codepen.io/134442/pushkar.mp3" as="audio">

    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
</head>
<body>
    <svg style="display: none;">
        <defs>
            <filter id="distortionFilter">
                <feTurbulence type="fractalNoise" baseFrequency="0.002 0.004" numOctaves="3" seed="2" stitchTiles="stitch" x="0%" y="0%" width="100%" height="100%" result="turbulence"/>
                <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="0" xChannelSelector="R" yChannelSelector="B" x="0%" y="0%" width="100%" height="100%" result="displacement"/>
            </filter>
        </defs>
    </svg>
    <canvas id="dust-canvas"></canvas>
    <div class="noise-overlay"></div>
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>

    <!-- The Unveiling: A moment of quiet anticipation. -->
    <div class="unveiling" id="unveiling">
        <h1 class="word">‡§Æ‡§∞‡•Å</h1>
        <audio id="sarangi-note" src="https://assets.codepen.io/134442/sarangi.mp3" preload="auto"></audio>
    </div>

    <!-- The Main Canvas -->
    <main id="maru-canvas">
        <div class="chapters-container" id="chapters-container">
            <!-- Chapter 1: Jaipur -->
            <section class="chapter" id="chapter-jaipur" data-accent-color="#F4CAC3" data-ambient-sound-src="https://assets.codepen.io/134442/jaipur.mp3">
                <div id="bg-jaipur" class="bg-image"></div>
                <div class="chapter-content glass-card">
                    <h1 class="chapter-title">Jaipur<br>The Rose</h1>
                    <p class="chapter-description">Conceived by a Maharaja's dream of hospitality, each facade captures the morning's first light. A metropolis not merely constructed, but brought to life with a blush.</p>
                    <button class="landmark" data-emoji="üí®" data-title="Hawa Mahal" data-description="It is not a palace, but a veil. A thousand apertures for a thousand gazes to observe the world, themselves unobserved. A partition of breeze and rock.">Discover Hawa Mahal</button>
                    <button class="landmark" data-emoji="üè∞" data-title="Amber Fort" data-description="A formidable citadel-palace of ruddy sandstone and ivory marble, a monument to Rajput magnificence.">Journey to Amber Fort</button>
                    <button class="landmark" data-emoji="üïå" data-title="City Palace" data-description="An expansive labyrinth of plazas, gardens, and structures, the vibrant core of the ancient city.">Walk the City Palace</button>
                </div>
            </section>

            <!-- Chapter 2: Jodhpur -->
            <section class="chapter" id="chapter-jodhpur" data-accent-color="#B0D0E8" data-ambient-sound-src="https://assets.codepen.io/134442/jodhpur.mp3">
                <div id="bg-jodhpur" class="bg-image"></div>
                <div class="chapter-content glass-card">
                    <h1 class="chapter-title">Jodhpur<br>The Indigo</h1>
                    <p class="chapter-description">An ocean of blue, flowing down the stone from the base of Mehrangarh. A hue to temper the heat, a sanctuary for the heavens.</p>
                    <button class="landmark pullable-element" data-emoji="üè∞" data-title="Mehrangarh Fort" data-description="It does not ascend. It emerges from the stone, a continuation of the land, erected by titans and polished by the sun.">Explore Mehrangarh</button>
                    <button class="landmark" data-emoji="üïäÔ∏è" data-title="Jaswant Thada" data-description="A tranquil marble memorial, a tribute to Maharaja Jaswant Singh II.">Meditate at Jaswant Thada</button>
                    <button class="landmark" data-emoji="üëë" data-title="Umaid Bhawan Palace" data-description="A splendid palace, serving as a hotel, museum, and royal home.">Discover Umaid Bhawan</button>
                </div>
            </section>

            <!-- Chapter 3: Jaisalmer -->
            <section class="chapter" data-accent-color="#FAE3C6" data-ambient-sound-src="https://assets.codepen.io/134442/jaisalmer.mp3">
                <div id="bg-jaisalmer" class="bg-image"></div>
                <div class="chapter-content glass-card">
                    <h1 class="chapter-title">Jaisalmer<br>The Golden</h1>
                    <p class="chapter-description">An illusion brought to life. A fortress of sand engineered to endure millennia, radiant with the stored brilliance of a desert midday.</p>
                    <button class="landmark pullable-element" data-emoji="üèúÔ∏è" data-title="The Living Fort" data-description="Inside these gilded ramparts, existence persists as it has for centuries. Markets, residences, and shrines resonate with a serene, enduring vitality.">Tread the Ramparts</button>
                    <button class="landmark" data-emoji="üèòÔ∏è" data-title="Patwon Ki Haveli" data-description="A collection of five mansions, a marvel of detailed craftsmanship.">Marvel at the Havelis</button>
                    <button class="landmark" data-emoji="üê™" data-title="Sam Sand Dunes" data-description="Feel the enchantment of the wilderness with a camel trek on the gilded sands.">Traverse the Dunes</button>
                </div>
            </section>

            <!-- Chapter 4: Udaipur -->
            <section class="chapter" data-accent-color="#C1E8E5" data-ambient-sound-src="https://assets.codepen.io/134442/udaipur.mp3">
                <div id="bg-udaipur" class="bg-image"></div>
                <div class="chapter-content glass-card">
                    <h1 class="chapter-title">Udaipur<br>The White</h1>
                    <p class="chapter-description">A metropolis of alabaster and liquid, where castles appear to levitate on the water's expanse. A vision mirrored in the tranquility of Pichola.</p>
                    <button class="landmark" data-emoji="üåä" data-title="Lake Pichola" data-description="The soul of Udaipur. In daylight, it reflects the sun; at night, it becomes a tapestry for the constellations and illuminated castles.">Float on the Lake</button>
                    <button class="landmark" data-emoji="üèØ" data-title="City Palace of Udaipur" data-description="A grand palace labyrinth, a fusion of Rajasthani and Mughal designs.">Wander the Palace</button>
                    <button class="landmark" data-emoji="üèùÔ∏è" data-title="Jag Mandir" data-description="A castle erected on an isle in Lake Pichola, a sanctuary of serene elegance.">See Jag Mandir</button>
                </div>
            </section>
            
            <!-- Chapter 5: The Thar -->
            <section class="chapter" data-accent-color="#E8DCCA" data-ambient-sound-src="https://assets.codepen.io/134442/thar.mp3">
                <div id="bg-thar" class="bg-image"></div>
                <div class="chapter-content glass-card">
                    <h1 class="chapter-title">The Thar<br>The Silence</h1>
                    <p class="chapter-description">The immense void, where the terrain is shaped solely by the breeze. Here, the skyline is the solitary goal, and the quietude is the most resonant noise.</p>
                    <button class="landmark pullable-element" data-emoji="üåÖ" data-title="The Dunes" data-description="A sea of sand, perpetually shifting, eternally calm. To observe the sunrise here is to behold the planet's creation.">Experience the Dawn</button>
                    <button class="landmark" data-emoji="üèûÔ∏è" data-title="Desert National Park" data-description="A broad region of sand and stone, supporting a distinctive ecosystem.">Discover the Park</button>
                    <button class="landmark" data-emoji="üõñ" data-title="Khuri Village" data-description="Immerse yourself in the customary way of life of the desert inhabitants in this quaint hamlet.">Journey to Khuri</button>
                </div>
            </section>

            <!-- Chapter 6: Pushkar -->
            <section class="chapter" data-accent-color="#E0C3FC" data-ambient-sound-src="https://assets.codepen.io/134442/pushkar.mp3">
                <div id="bg-pushkar" class="bg-image"></div>
                <div class="chapter-content glass-card">
                    <h1 class="chapter-title">Pushkar<br>The Divine</h1>
                    <p class="chapter-description">A hallowed village on the banks of a sacred lake, a site of devotion and belief.</p>
                    <button class="landmark" data-emoji="üíß" data-title="Pushkar Lake" data-description="A consecrated lake encircled by 52 bathing spots, where devotees arrive to cleanse and worship.">Feel the Lake</button>
                    <button class="landmark" data-emoji="üïâÔ∏è" data-title="Brahma Temple" data-description="Among the rare shrines globally devoted to Lord Brahma, the originator.">See the Temple</button>
                    <button class="landmark" data-emoji="üôè" data-title="Savitri Temple" data-description="A shrine for Brahma's spouse, providing sweeping vistas of the village.">Ascend to Savitri</button>
                </div>
            </section>
        </div>

        <!-- Shared UI Elements -->
        <div class="artisan-hand" title="The Artisan's Hand" tabindex="0">
             <video src="https://assets.codepen.io/134442/potter.mp4" autoplay loop muted playsinline></video>
        </div>

        <button id="sound-toggle" title="Listen" aria-label="Enable sound" aria-pressed="false">
            <svg id="sound-icon-off" viewBox="0 0 24 24">
                <line x1="1" y1="1" x2="23" y2="23"></line>
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v10"></path>
            </svg>
            <svg id="sound-icon-on" style="display: none;" viewBox="0 0 24 24">
                <path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
        </button>

        <div id="thread-timeline">
            <div class="thread-guide">
                <div class="thread-progress" id="thread-progress"></div>
            </div>
            <span class="thread-guide-text">YOUR THREAD</span>
        </div>
        <div class="scroll-indicator"></div>
    </main>

    <!-- The Detail View Layer -->
    <div id="detail-view">
        <div class="detail-content">
            <div class="detail-emoji" id="detail-emoji"></div>
            <h2 id="detail-title"></h2>
            <p id="detail-description"></p>
            <button class="close-btn" id="close-detail-btn">CLOSE</button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Jony Ive: The Digital Craftsman - Elevated

        // --- SECTION 1: ELEMENT REFERENCES ---
        const unveiling = document.getElementById('unveiling');
        const sarangiNote = document.getElementById('sarangi-note');
        const maruCanvas = document.getElementById('maru-canvas');
        const container = document.getElementById('chapters-container');
        const chapters = gsap.utils.toArray('.chapter');
        const detailView = document.getElementById('detail-view');
        const detailEmoji = document.getElementById('detail-emoji');
        const detailTitle = document.getElementById('detail-title');
        const detailDescription = document.getElementById('detail-description');
        const closeDetailBtn = document.getElementById('close-detail-btn');
        const landmarks = document.querySelectorAll('.landmark');
        const cursorDot = document.querySelector('.cursor-dot');
        const cursorOutline = document.querySelector('.cursor-outline');

        const numChapters = chapters.length;
        container.style.width = `${numChapters * 100}%`;
        let currentChapter = 0;
        let isScrolling = false;
        
        // --- SECTION 1.2: TEXT SPLITTING UTILITY ---
        function splitText(element, type = 'words') {
            if (!element) return;
            const text = element.innerText;
            const words = text.split(' ');

            element.innerHTML = words.map(word => {
                if(word.includes('\n')) {
                    const parts = word.split('\n');
                     return parts.map((part, i) => {
                        const content = type === 'chars'
                            ? part.split('').map(char => `<span class="char" style="display:inline-block;">${char}</span>`).join('')
                            : part;
                        return `<span class="word" style="display:inline-block;">${content}</span>${i < parts.length - 1 ? '<br>' : ''}`;
                    }).join('');
                }
                const content = type === 'chars'
                    ? word.split('').map(char => `<span class="char" style="display:inline-block;">${char}</span>`).join('')
                    : word;
                return `<span class="word" style="display:inline-block;">${content}</span>`;
            }).join(' ');

            return type === 'chars' ? element.querySelectorAll('.char') : element.querySelectorAll('.word');
        }

        chapters.forEach(chapter => {
            splitText(chapter.querySelector('.chapter-title'), 'chars');
            splitText(chapter.querySelector('.chapter-description'), 'words');
        });

        // --- SECTION 1.5: CURSOR & INTERACTION LOGIC ---
        let mouseX = 0;
        let mouseY = 0;

        gsap.set(cursorDot, { xPercent: -50, yPercent: -50 });
        gsap.set(cursorOutline, { xPercent: -50, yPercent: -50 });

        const xTo = gsap.quickTo(cursorOutline, "x", { duration: 0.2, ease: "power3" });
        const yTo = gsap.quickTo(cursorOutline, "y", { duration: 0.2, ease: "power3" });

        const displacementMap = document.querySelector('#distortionFilter feDisplacementMap');

        window.addEventListener("mousemove", (e) => {
            const velocity = Math.sqrt(Math.pow(e.movementX, 2) + Math.pow(e.movementY, 2));
            mouseX = e.clientX;
            mouseY = e.clientY;

            gsap.to(cursorDot, { x: mouseX, y: mouseY, duration: 0.01 });
            xTo(mouseX);
            yTo(mouseY);

            // Liquid Distortion
            const agitation = Math.min(velocity * 1.5, 60);
            gsap.to(displacementMap, {
                attr: { scale: agitation },
                duration: 0.8,
                ease: 'power2.out',
                overwrite: 'auto'
            });
            gsap.to(displacementMap, {
                attr: { scale: 0 },
                duration: 1.5,
                delay: 0.1,
                ease: 'power2.out',
                overwrite: 'auto'
            });

            // Parallax & 3D Tilt
            if (!isScrolling && chapters[currentChapter]) {
                const chapter = chapters[currentChapter];
                const content = chapter.querySelector('.chapter-content');
                const glassCard = chapter.querySelector('.glass-card');
                const bg = chapter.querySelector('.bg-image');

                const xPct = (mouseX / window.innerWidth - 0.5);
                const yPct = (mouseY / window.innerHeight - 0.5);

                if(bg) {
                    gsap.to(bg, { x: xPct * 30, y: yPct * 30, duration: 1, ease: 'power2.out' });
                }

                // 3D Tilt for Glass Card
                if (glassCard) {
                     const rect = glassCard.getBoundingClientRect();
                     const cardX = rect.left + rect.width / 2;
                     const cardY = rect.top + rect.height / 2;
                     // Calculate distance from center of card
                     const distX = mouseX - cardX;
                     const distY = mouseY - cardY;

                     const rotateY = distX / 60;
                     const rotateX = -distY / 60;

                     gsap.to(glassCard, {
                         rotateX: rotateX,
                         rotateY: rotateY,
                         transformPerspective: 1000,
                         duration: 1,
                         ease: 'power2.out'
                     });

                     // Shimmer update (handled via CSS opacity on hover, but we can enhance position)
                     // Setting a CSS var for mouse position could be cool too
                }
            }
        });

        // Hover States
        const interactiveElements = document.querySelectorAll('button, a, .landmark, .artisan-hand, .pullable-element');
        interactiveElements.forEach(el => {
            el.addEventListener('mouseenter', () => cursorOutline.classList.add('hover'));
            el.addEventListener('mouseleave', () => cursorOutline.classList.remove('hover'));
        });

        // Magnetic Effect
        function magneticEffect(element) {
            if (!element) return;
            const xTo = gsap.quickTo(element, "x", { duration: 1, ease: "elastic.out(1, 0.4)" });
            const yTo = gsap.quickTo(element, "y", { duration: 1, ease: "elastic.out(1, 0.4)" });

            element.addEventListener("mousemove", (e) => {
                const { clientX, clientY } = e;
                const { left, top, width, height } = element.getBoundingClientRect();
                const x = clientX - (left + width / 2);
                const y = clientY - (top + height / 2);
                xTo(x * 0.4);
                yTo(y * 0.4);
            });
            element.addEventListener("mouseleave", () => {
                xTo(0);
                yTo(0);
            });
        }

        magneticEffect(document.querySelector('.artisan-hand'));
        magneticEffect(document.getElementById('sound-toggle'));
        landmarks.forEach(l => magneticEffect(l));

        // --- SECTION 2: UNVEILING ---
        let unveilingAnimation;
        function skipUnveiling() {
            clearTimeout(unveilingAnimation);
            unveiling.classList.add('hidden');
            maruCanvas.classList.add('visible');
            chapters[0].classList.add('active');
            unveiling.removeEventListener('click', skipUnveiling);

            // Trigger initial entry for first chapter
            const titleChars = chapters[0].querySelectorAll('.chapter-title .char');
            const descWords = chapters[0].querySelectorAll('.chapter-description .word');

            gsap.fromTo(titleChars,
                { y: 100, opacity: 0, rotateZ: 10 },
                { y: 0, opacity: 1, rotateZ: 0, duration: 1, stagger: 0.05, ease: 'back.out(1.7)' }
            );
            gsap.fromTo(descWords,
                { y: 20, opacity: 0 },
                { y: 0, opacity: 0.8, duration: 1, stagger: 0.02, delay: 0.5, ease: 'power2.out' }
            );
        }

        unveiling.addEventListener('click', skipUnveiling);
        unveilingAnimation = setTimeout(() => {
            unveiling.querySelector('.word').style.animationPlayState = 'running';
            unveilingAnimation = setTimeout(() => {
                sarangiNote.volume = 0.5;
                sarangiNote.play().catch(() => {});
                unveilingAnimation = setTimeout(skipUnveiling, 3500);
            }, 2000);
        }, 500);

        // --- SECTION 3: SCROLLING ---
        window.addEventListener('wheel', (e) => {
            if (isScrolling) return;
            if (e.deltaY > 50 && currentChapter < numChapters - 1) goToChapter(currentChapter + 1);
            else if (e.deltaY < -50 && currentChapter > 0) goToChapter(currentChapter - 1);
        });

        window.addEventListener('keydown', (e) => {
            if (isScrolling) return;
            if (e.key === 'ArrowRight' && currentChapter < numChapters - 1) goToChapter(currentChapter + 1);
            else if (e.key === 'ArrowLeft' && currentChapter > 0) goToChapter(currentChapter - 1);
        });

        // --- SECTION 4: DETAIL VIEW (FLIP ANIMATION) ---
        function openDetailView(title, description, emoji, triggerElement) {
            detailEmoji.textContent = emoji;
            detailTitle.textContent = title;
            detailDescription.textContent = description;

            detailView.classList.add('visible');

            const content = detailView.querySelector('.detail-content');

            // Simple FLIP-like scaling from center for now, or from trigger if present
            if (triggerElement) {
                const rect = triggerElement.getBoundingClientRect();
                // We could do a complex FLIP here, but a clean scale in is often smoother/less buggy
                // Let's stick to a premium scale-in with a slight rotation
                gsap.fromTo(content,
                    { scale: 0.5, opacity: 0, rotateX: 20 },
                    { scale: 1, opacity: 1, rotateX: 0, duration: 0.6, ease: 'back.out(1.5)' }
                );
            } else {
                 gsap.fromTo(content,
                    { scale: 0.8, opacity: 0 },
                    { scale: 1, opacity: 1, duration: 0.5, ease: 'back.out(1.7)' }
                );
            }

            closeDetailBtn.focus();
        }

        function closeDetailView() {
            const content = detailView.querySelector('.detail-content');
            gsap.to(content, {
                scale: 0.9,
                opacity: 0,
                duration: 0.4,
                ease: 'power3.in',
                onComplete: () => {
                    detailView.classList.remove('visible');
                    gsap.set(content, { clearProps: "all" }); // Reset for next open
                }
            });
            if (document.activeElement) document.activeElement.blur();
        }

        landmarks.forEach(landmark => {
            landmark.setAttribute('tabindex', '0');
            landmark.addEventListener('click', (e) => {
                e.preventDefault();
                openDetailView(landmark.dataset.title, landmark.dataset.description, landmark.dataset.emoji, landmark);
            });
            landmark.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    openDetailView(landmark.dataset.title, landmark.dataset.description, landmark.dataset.emoji, landmark);
                }
            });
        });

        closeDetailBtn.addEventListener('click', closeDetailView);
        detailView.addEventListener('click', (e) => { if (e.target === detailView) closeDetailView(); });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && detailView.classList.contains('visible')) closeDetailView(); });

        // --- SECTION 5: SOUND ---
        const soundToggle = document.getElementById('sound-toggle');
        const soundIconOn = document.getElementById('sound-icon-on');
        const soundIconOff = document.getElementById('sound-icon-off');
        let isSoundOn = false;
        const ambientSounds = chapters.map(chapter => {
            const src = chapter.dataset.ambientSoundSrc;
            return src ? new Audio(src) : null;
        });

        function playCurrentAmbientSound() {
            if (isSoundOn) {
                ambientSounds.forEach((sound, index) => {
                    if (sound) {
                        if (index === currentChapter) {
                            sound.loop = true;
                            sound.play().catch(()=>{});
                        } else {
                            sound.pause();
                        }
                    }
                });
            }
        }

        function stopAllAmbientSounds() {
            ambientSounds.forEach(sound => { if (sound) sound.pause(); });
        }

        soundToggle.addEventListener('click', () => {
            isSoundOn = !isSoundOn;
            soundToggle.setAttribute('aria-pressed', isSoundOn);
            if(isSoundOn) {
                soundIconOn.style.display = 'block';
                soundIconOff.style.display = 'none';
                soundToggle.title = 'Mute';
                playCurrentAmbientSound();
            } else {
                soundIconOn.style.display = 'none';
                soundIconOff.style.display = 'block';
                soundToggle.title = 'Listen';
                stopAllAmbientSounds();
            }
        });

        // --- SECTION 5.5: TIMELINE ---
        const timeline = document.getElementById('thread-timeline');
        timeline.addEventListener('click', (e) => {
            const rect = timeline.getBoundingClientRect();
            const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            const targetIndex = Math.round(pct * (numChapters - 1));
            if (targetIndex !== currentChapter) goToChapter(targetIndex);
        });

        function goToChapter(index) {
            if (isScrolling) return;
            isScrolling = true;
            chapters.forEach(ch => ch.classList.remove('active'));

            const nextChapter = chapters[index];
            const titleChars = nextChapter.querySelectorAll('.chapter-title .char');
            const descWords = nextChapter.querySelectorAll('.chapter-description .word');

            gsap.set(titleChars, { y: 100, opacity: 0, rotateZ: 10, skewX: 20, filter: 'blur(10px)' });
            gsap.set(descWords, { y: 20, opacity: 0 });

            // Transition: Silky Distortion
            const displacement = document.querySelector('#distortionFilter feDisplacementMap');
            gsap.to(displacement, {
                attr: { scale: 300 }, // Higher scale for more drama
                duration: 1.0,
                ease: 'power2.inOut',
                onComplete: () => {
                    gsap.to(displacement, {
                        attr: { scale: 0 },
                        duration: 1.2,
                        ease: 'power2.out'
                    });
                }
            });

            gsap.to(container, {
                x: -index * window.innerWidth,
                duration: 1.8, // Slower, more majestic
                ease: 'power4.inOut',
                onComplete: () => {
                    isScrolling = false;
                    currentChapter = index;
                    chapters[currentChapter].classList.add('active');

                    // Cinematic Text Entry
                    gsap.to(titleChars, {
                        y: 0,
                        opacity: 1,
                        rotateZ: 0,
                        skewX: 0,
                        filter: 'blur(0px)',
                        duration: 1.2,
                        stagger: 0.03,
                        ease: 'back.out(1.2)'
                    });

                    gsap.to(descWords, {
                        y: 0,
                        opacity: 0.8,
                        duration: 1,
                        stagger: 0.01,
                        delay: 0.3,
                        ease: 'power2.out'
                    });
                    playCurrentAmbientSound();
                }
            });

            const newColor = chapters[index].dataset.accentColor;
            gsap.to(':root', { '--accent-color': newColor, duration: 1.5, ease: 'power2.out' });

            const progress = (index / (numChapters - 1)) * 100;
            gsap.to('#thread-progress', { width: `${progress}%`, duration: 1.8, ease: 'power4.inOut' });
        }

        // --- SECTION 6: CONSTELLATION DUST SYSTEM ---
        class DustSystem {
            constructor() {
                this.canvas = document.getElementById('dust-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.numParticles = 60; // Fewer but smarter particles
                this.resize();
                window.addEventListener('resize', () => this.resize());
                for(let i = 0; i < this.numParticles; i++) this.particles.push(this.createParticle());
                this.animate();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            createParticle() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    vx: (Math.random() - 0.5) * 0.3,
                    vy: (Math.random() - 0.5) * 0.3,
                    size: Math.random() * 2 + 1,
                    alpha: Math.random() * 0.5 + 0.2
                };
            }

            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                const wind = (mouseX - window.innerWidth / 2) * 0.00005;

                this.particles.forEach((p, i) => {
                    p.x += p.vx + wind;
                    p.y += p.vy;

                    // Mouse Interaction (Repulsion)
                    const dx = mouseX - p.x;
                    const dy = mouseY - p.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 200) {
                        const angle = Math.atan2(dy, dx);
                        const force = (200 - dist) / 200;
                        p.vx -= Math.cos(angle) * force * 0.02;
                        p.vy -= Math.sin(angle) * force * 0.02;
                    }

                    // Friction
                    p.vx *= 0.99;
                    p.vy *= 0.99;

                    // Boundaries
                    if (p.x < 0) p.x = this.canvas.width;
                    if (p.x > this.canvas.width) p.x = 0;
                    if (p.y < 0) p.y = this.canvas.height;
                    if (p.y > this.canvas.height) p.y = 0;

                    // Draw Particle
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();

                    // Draw Connections
                    for (let j = i + 1; j < this.particles.length; j++) {
                        const p2 = this.particles[j];
                        const dx2 = p.x - p2.x;
                        const dy2 = p.y - p2.y;
                        const dist2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);

                        if (dist2 < 120) {
                            this.ctx.beginPath();
                            this.ctx.strokeStyle = `rgba(255, 255, 255, ${0.15 * (1 - dist2 / 120)})`;
                            this.ctx.lineWidth = 0.5;
                            this.ctx.moveTo(p.x, p.y);
                            this.ctx.lineTo(p2.x, p2.y);
                            this.ctx.stroke();
                        }
                    }
                });
                requestAnimationFrame(() => this.animate());
            }
        }
        new DustSystem();
    });
    </script>
</body>
</html>
